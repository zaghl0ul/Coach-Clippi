<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Coach Clippi - Coaching Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #ffffff;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Tab Navigation */
    #tab-nav {
      background: linear-gradient(135deg, #21ba45 0%, #19642e 100%);
      display: flex;
      padding: 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .tab-btn.active {
      background: rgba(0, 0, 0, 0.2);
      border-bottom-color: #fff;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    }
    
    .tab-content.active {
      display: flex;
      flex-direction: column;
    }
    
    /* Status Bar */
    #status-bar {
      background: #16213e;
      padding: 8px 15px;
      border-top: 2px solid #21ba45;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
    }
    
    #status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #888;
      animation: pulse 2s infinite;
    }
    
    #status-dot.active {
      background: #21ba45;
      box-shadow: 0 0 15px rgba(33, 186, 69, 0.6);
    }
    
    #status-dot.inactive {
      background: #ff3838;
      animation: none;
    }
    
    /* Messages Tab */
    #messages-container {
      flex: 1;
    }
    
    .message-card {
      background: linear-gradient(135deg, rgba(33, 186, 69, 0.15) 0%, rgba(25, 140, 52, 0.1) 100%);
      border: 2px solid rgba(33, 186, 69, 0.3);
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 15px;
      animation: slideIn 0.4s ease-out;
      position: relative;
      overflow: hidden;
    }
    
    .message-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, #21ba45, #2dd855);
    }
    
    .message-content {
      color: #ffffff;
      font-size: 16px;
      font-weight: 500;
      line-height: 1.5;
      padding-left: 10px;
    }
    
    .message-time {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
      padding-left: 10px;
    }
    
    /* Diagnostics Tab */
    #diagnostics-container {
      gap: 15px;
    }
    
    .diagnostic-section {
      background: rgba(33, 186, 69, 0.1);
      border: 1px solid rgba(33, 186, 69, 0.2);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .diagnostic-section h3 {
      color: #21ba45;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .diagnostic-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 13px;
    }
    
    .diagnostic-label {
      color: #aaa;
    }
    
    .diagnostic-value {
      color: #fff;
      font-weight: 600;
    }
    
    .window-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .window-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }
    
    .window-item:hover {
      background: rgba(33, 186, 69, 0.2);
      border-color: #21ba45;
    }
    
    .window-item.selected {
      background: rgba(33, 186, 69, 0.3);
      border-color: #21ba45;
    }
    
    /* Logs Tab */
    #logs-container {
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 12px;
      background: #0d0d0d;
      border-radius: 4px;
      padding: 10px;
      overflow-y: auto;
    }
    
    .log-entry {
      padding: 3px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      word-wrap: break-word;
    }
    
    .log-entry.DEBUG { color: #888; }
    .log-entry.INFO { color: #4a9eff; }
    .log-entry.WARN { color: #ffb84a; }
    .log-entry.ERROR { color: #ff4a4a; }
    .log-entry.DETECTION { color: #21ba45; }
    
    .log-timestamp {
      color: #666;
      margin-right: 10px;
    }
    
    .log-level {
      font-weight: bold;
      margin-right: 10px;
    }
    
    /* Settings Tab */
    #settings-container {
      padding: 20px;
    }
    
    .setting-group {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .setting-group h3 {
      color: #21ba45;
      margin-bottom: 15px;
    }
    
    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    .setting-label {
      color: #ccc;
      font-size: 14px;
    }
    
    .setting-input {
      padding: 5px 10px;
      background: #1a1a2e;
      border: 1px solid #21ba45;
      border-radius: 4px;
      color: white;
      font-size: 13px;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #21ba45;
    }
    
    /* Buttons */
    .btn {
      padding: 8px 20px;
      background: linear-gradient(135deg, #21ba45, #19642e);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, #2dd855, #21ba45);
      transform: translateY(-2px);
    }
    
    .btn.secondary {
      background: linear-gradient(135deg, #444, #333);
    }
    
    .btn.secondary:hover {
      background: linear-gradient(135deg, #555, #444);
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #16213e;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #21ba45;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #2dd855;
    }
    
    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <!-- Tab Navigation -->
  <div id="tab-nav">
    <button class="tab-btn active" onclick="switchTab('messages')">Messages</button>
    <button class="tab-btn" onclick="switchTab('diagnostics')">Diagnostics</button>
    <button class="tab-btn" onclick="switchTab('logs')">Logs</button>
    <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
  </div>
  
  <!-- Messages Tab -->
  <div id="messages" class="tab-content active">
    <div id="messages-container">
      <div style="text-align: center; padding: 40px; color: #888;">
        <h2 style="color: #21ba45; margin-bottom: 10px;">Coach Clippi</h2>
        <p>Waiting for coaching messages...</p>
      </div>
    </div>
  </div>
  
  <!-- Diagnostics Tab -->
  <div id="diagnostics" class="tab-content">
    <div id="diagnostics-container">
      <!-- Detection Status -->
      <div class="diagnostic-section">
        <h3>Detection Status</h3>
        <div class="diagnostic-item">
          <span class="diagnostic-label">Status:</span>
          <span class="diagnostic-value" id="detection-status">Not Detected</span>
        </div>
        <div class="diagnostic-item">
          <span class="diagnostic-label">Target Window:</span>
          <span class="diagnostic-value" id="target-window">None</span>
        </div>
        <div class="diagnostic-item">
          <span class="diagnostic-label">PID:</span>
          <span class="diagnostic-value" id="target-pid">-</span>
        </div>
        <div class="diagnostic-item">
          <span class="diagnostic-label">Detection Attempts:</span>
          <span class="diagnostic-value" id="detection-attempts">0</span>
        </div>
        <div class="diagnostic-item">
          <span class="diagnostic-label">Last Detection:</span>
          <span class="diagnostic-value" id="last-detection">Never</span>
        </div>
        <button class="btn" onclick="manualDetect()">Manual Detect</button>
      </div>
      
      <!-- Detected Windows -->
      <div class="diagnostic-section">
        <h3>Detected Windows</h3>
        <div id="window-list" class="window-list">
          <div style="color: #666; padding: 10px;">No windows detected yet</div>
        </div>
      </div>
      
      <!-- System Info -->
      <div class="diagnostic-section">
        <h3>System Information</h3>
        <div class="diagnostic-item">
          <span class="diagnostic-label">Log Location:</span>
          <span class="diagnostic-value" id="log-location" style="font-size: 11px;">Loading...</span>
        </div>
        <button class="btn secondary" onclick="openLogFolder()">Open Log Folder</button>
        <button class="btn secondary" onclick="clearLogs()">Clear Logs</button>
      </div>
    </div>
  </div>
  
  <!-- Logs Tab -->
  <div id="logs" class="tab-content">
    <div style="padding: 10px; display: flex; gap: 10px;">
      <button class="btn secondary" onclick="refreshLogs()">Refresh</button>
      <button class="btn secondary" onclick="clearLogDisplay()">Clear Display</button>
    </div>
    <div id="logs-container"></div>
  </div>
  
  <!-- Settings Tab -->
  <div id="settings" class="tab-content">
    <div id="settings-container">
      <div class="setting-group">
        <h3>Detection Methods</h3>
        <div class="setting-item">
          <label class="setting-label">By Process ID</label>
          <input type="checkbox" id="method-pid" checked onchange="updateConfig()">
        </div>
        <div class="setting-item">
          <label class="setting-label">By Process Name</label>
          <input type="checkbox" id="method-process" checked onchange="updateConfig()">
        </div>
        <div class="setting-item">
          <label class="setting-label">By Window Title</label>
          <input type="checkbox" id="method-title" checked onchange="updateConfig()">
        </div>
        <div class="setting-item">
          <label class="setting-label">By Class Name</label>
          <input type="checkbox" id="method-class" checked onchange="updateConfig()">
        </div>
      </div>
      
      <div class="setting-group">
        <h3>Manual Configuration</h3>
        <div class="setting-item">
          <label class="setting-label">Target PID (optional)</label>
          <input type="number" id="target-pid-input" class="setting-input" placeholder="e.g. 4256" onchange="updateConfig()">
        </div>
        <div class="setting-item">
          <label class="setting-label">Scan Interval (ms)</label>
          <input type="number" id="scan-interval" class="setting-input" value="500" onchange="updateConfig()">
        </div>
      </div>
      
      <div class="setting-group">
        <h3>Window Options</h3>
        <div class="setting-item">
          <label class="setting-label">Always On Top</label>
          <input type="checkbox" id="always-on-top" checked onchange="toggleAlwaysOnTop()">
        </div>
        <div class="setting-item">
          <label class="setting-label">Show Diagnostics</label>
          <input type="checkbox" id="show-diagnostics" checked onchange="updateConfig()">
        </div>
      </div>
    </div>
  </div>
  
  <!-- Status Bar -->
  <div id="status-bar">
    <div id="status-indicator">
      <div id="status-dot" class="inactive"></div>
      <span id="status-text">Waiting for Dolphin...</span>
    </div>
    <div id="status-info" style="font-size: 11px; color: #888;"></div>
  </div>
  
  <script>
    const { ipcRenderer } = require('electron');
    const { shell } = require('electron');
    
    let dolphinInfo = null;
    let messages = [];
    let logs = [];
    let config = null;
    let logPaths = null;
    
    // Tab switching
    function switchTab(tabName) {
      // Update buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');
      
      // Refresh logs when switching to logs tab
      if (tabName === 'logs') {
        refreshLogs();
      }
    }
    
    // Handle Dolphin detection
    ipcRenderer.on('dolphin-found', (event, info) => {
      dolphinInfo = info;
      updateDetectionStatus(true);
    });
    
    ipcRenderer.on('dolphin-not-found', () => {
      dolphinInfo = null;
      updateDetectionStatus(false);
    });
    
    // Handle detection stats
    ipcRenderer.on('detection-stats', (event, stats) => {
      document.getElementById('detection-attempts').textContent = stats.detectionAttempts;
      document.getElementById('last-detection').textContent = 
        stats.lastDetectionTime ? new Date(stats.lastDetectionTime).toLocaleTimeString() : 'Never';
      
      // Update window list
      updateWindowList(stats.allWindows);
    });
    
    // Update detection status display
    function updateDetectionStatus(found) {
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const detectionStatus = document.getElementById('detection-status');
      const targetWindow = document.getElementById('target-window');
      const targetPid = document.getElementById('target-pid');
      
      if (found && dolphinInfo) {
        statusDot.className = 'active';
        statusText.textContent = 'Connected to Dolphin';
        detectionStatus.textContent = 'Detected';
        detectionStatus.style.color = '#21ba45';
        targetWindow.textContent = dolphinInfo.title || 'Unknown';
        targetPid.textContent = dolphinInfo.pid || '-';
        
        document.getElementById('status-info').textContent = 
          `PID: ${dolphinInfo.pid} | ${dolphinInfo.className || ''}`;
      } else {
        statusDot.className = 'inactive';
        statusText.textContent = 'Dolphin not found';
        detectionStatus.textContent = 'Not Detected';
        detectionStatus.style.color = '#ff3838';
        targetWindow.textContent = 'None';
        targetPid.textContent = '-';
        document.getElementById('status-info').textContent = '';
      }
    }
    
    // Update window list
    function updateWindowList(windows) {
      const windowList = document.getElementById('window-list');
      
      if (!windows || windows.length === 0) {
        windowList.innerHTML = '<div style="color: #666; padding: 10px;">No windows detected</div>';
        return;
      }
      
      windowList.innerHTML = '';
      windows.forEach(window => {
        const item = document.createElement('div');
        item.className = 'window-item';
        if (dolphinInfo && window.pid === dolphinInfo.pid) {
          item.classList.add('selected');
        }
        item.innerHTML = `
          <div><strong>${window.title || 'Untitled'}</strong></div>
          <div style="font-size: 11px; color: #888;">
            PID: ${window.pid} | ${window.processName} | ${window.className}
            <br>Size: ${window.width}x${window.height} at (${window.x}, ${window.y})
          </div>
        `;
        item.onclick = () => selectWindow(window);
        windowList.appendChild(item);
      });
    }
    
    // Display coaching message
    ipcRenderer.on('display-message', (event, message) => {
      displayMessage(message);
    });
    
    function displayMessage(text) {
      const container = document.getElementById('messages-container');
      
      // Remove placeholder if exists
      if (container.querySelector('div[style*="text-align: center"]')) {
        container.innerHTML = '';
      }
      
      const messageCard = document.createElement('div');
      messageCard.className = 'message-card';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = text;
      
      const messageTime = document.createElement('div');
      messageTime.className = 'message-time';
      messageTime.textContent = new Date().toLocaleTimeString();
      
      messageCard.appendChild(messageContent);
      messageCard.appendChild(messageTime);
      container.appendChild(messageCard);
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
      
      // Keep only last 50 messages
      while (container.children.length > 50) {
        container.removeChild(container.firstChild);
      }
    }
    
    // Handle logs
    ipcRenderer.on('logs-data', (event, logsData) => {
      logs = logsData;
      displayLogs();
    });
    
    function displayLogs() {
      const container = document.getElementById('logs-container');
      container.innerHTML = '';
      
      logs.forEach(log => {
        const entry = document.createElement('div');
        entry.className = `log-entry ${log.level}`;
        
        const timestamp = new Date(log.timestamp).toLocaleTimeString();
        entry.innerHTML = `
          <span class="log-timestamp">${timestamp}</span>
          <span class="log-level">[${log.level}]</span>
          <span>${log.message}</span>
        `;
        
        if (log.data) {
          entry.innerHTML += `<pre style="margin-left: 20px; color: #666;">${JSON.stringify(log.data, null, 2)}</pre>`;
        }
        
        container.appendChild(entry);
      });
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    // Refresh logs
    function refreshLogs() {
      ipcRenderer.send('get-logs');
    }
    
    // Clear log display
    function clearLogDisplay() {
      document.getElementById('logs-container').innerHTML = '';
    }
    
    // Clear logs
    function clearLogs() {
      if (confirm('Clear all log files?')) {
        ipcRenderer.send('clear-logs');
        refreshLogs();
      }
    }
    
    // Manual detection
    function manualDetect() {
      ipcRenderer.send('manual-detect');
    }
    
    // Select window
    function selectWindow(window) {
      if (confirm(`Select "${window.title}" (PID: ${window.pid}) as target window?`)) {
        ipcRenderer.send('select-window', window.handle);
      }
    }
    
    // Handle config updates
    ipcRenderer.on('config-update', (event, newConfig) => {
      config = newConfig;
      applyConfig();
    });
    
    function applyConfig() {
      if (!config) return;
      
      // Update UI with config values
      document.getElementById('method-pid').checked = config.detection.methods.byPid;
      document.getElementById('method-process').checked = config.detection.methods.byProcessName;
      document.getElementById('method-title').checked = config.detection.methods.byWindowTitle;
      document.getElementById('method-class').checked = config.detection.methods.byClassName;
      
      if (config.detection.targetPid) {
        document.getElementById('target-pid-input').value = config.detection.targetPid;
      }
      
      document.getElementById('scan-interval').value = config.detection.scanInterval;
      document.getElementById('always-on-top').checked = config.overlay.alwaysOnTop;
      document.getElementById('show-diagnostics').checked = config.overlay.showDiagnostics;
    }
    
    // Update configuration
    function updateConfig() {
      if (!config) return;
      
      const newConfig = {
        detection: {
          ...config.detection,
          methods: {
            byPid: document.getElementById('method-pid').checked,
            byProcessName: document.getElementById('method-process').checked,
            byWindowTitle: document.getElementById('method-title').checked,
            byClassName: document.getElementById('method-class').checked
          },
          targetPid: parseInt(document.getElementById('target-pid-input').value) || null,
          scanInterval: parseInt(document.getElementById('scan-interval').value) || 500
        },
        overlay: {
          ...config.overlay,
          showDiagnostics: document.getElementById('show-diagnostics').checked
        }
      };
      
      ipcRenderer.send('update-config', newConfig);
    }
    
    // Toggle always on top
    function toggleAlwaysOnTop() {
      const checked = document.getElementById('always-on-top').checked;
      ipcRenderer.send('toggle-always-on-top', checked);
    }
    
    // Get log paths
    ipcRenderer.on('log-paths', (event, paths) => {
      logPaths = paths;
      document.getElementById('log-location').textContent = paths.logDir;
    });
    
    // Open log folder
    function openLogFolder() {
      if (logPaths) {
        shell.openPath(logPaths.logDir);
      }
    }
    
    // Initialize
    ipcRenderer.send('start-tracking');
    ipcRenderer.send('get-log-paths');
    refreshLogs();
    
    // Test messages in dev mode
    if (window.location.search.includes('dev')) {
      setTimeout(() => {
        displayMessage('Coach Clippi with Advanced Diagnostics initialized!');
      }, 2000);
    }
    
    console.log('Coach Clippi Overlay - Renderer Started');
  </script>
</body>
</html>
